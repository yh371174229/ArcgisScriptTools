#-------------------------------------------------------------------------------
# Name:        Copy, Paste, and Rename rasters - then calculate Winkler GDD
# Purpose:     This code must be run in several stages; the first chunk will rename #		rasters and place them in a new folder. The second will produce the #		growing degree days map.
#
# Author:      Sarah Trimble
#
# Created:     20/06/2013
# Copyright:   (c) strimble 2013
# Licence:     <your licence>
#-------------------------------------------------------------------------------

#Run this first:
#import os, sys, string, arcpy
#from arcpy import env, sa
#from arcpy.sa import *
#arcpy.env.workspace = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg"
#rasters = arcpy.ListRasters()
##this trimmed the names of all rasters in the folder to only the number (as in number
#day of the year - integers 1-365)
#for raster in rasters:
#         arcpy.Rename_management(raster, raster[10:])
#del rasters
##EXIT ArcCatalog and then open again so that the names reset

##REOPEN ArcCatalog
##At this point, my Daily Interpolated Lows and DInt Highs were in separate folders,
##with names that consisted of only digits, referring to the day of the year (1-365)
##so I ran this section twice, and just copy-and-pasted them into a single folder,
##then put them all in the workspace together so that I had one folder containing files
##with the naming scheme 103_L.tif and 103_H.tif from 1 to 365. This guarantees that
##rasters from the day are consecutive in the list generated by arcpy.ListRasters(). 
import os, sys, string, arcpy
from arcpy import env, sa
from arcpy.sa import *
arcpy.env.workspace = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg"
rasters = arcpy.ListRasters()
for raster in rasters:
    arcpy.Rename_management(raster, raster[0:-4]+"_L")
##OR:
#for raster in rasters:
#    arcpy.Rename_management(raster, raster[0:-4]+"_H")


##This next section of code will create rasters named avg_day366 by averaging together
##the high and low for each day, IF the names are correctly indexed by the naming system
##created above
i = 0
j = 1
count  = 0
outName = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg" + "\\" + "avg_day" + inRast1[0:-6])
inRast1 = rasters[i]
inRast2 = rasters[j]
while (count < 366):
    inRast1 = rasters[i]
    inRast2 = rasters[j]
    outName = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg" + "\\" + "avg_day" + inRast1[0:-6]
    outCellStats = CellStatistics([inRast1, inRast2], "MEAN")
    outCellStats.save(outName)
    ##Unfortunately the rasters are generated in the GRID format, but we'll convert them to tiff later
    i = i + 2
    j = j + 2
    count = count + 1
##NOTE: This while loop will end in an error because count will hit 366 and python will get
##upset, but it will correctly generate the average for each day so who cares
##After the error message, you can check that the resulting rasters are actually the
##averages you want by manually running the Raster Calculator tool on a randomly chosen
##day and subtracting the automaticcaly generated average (from above); if it worked,
##this result will be zero.

##Now redfine the list of rasters to select only the averages (avg_day366), and print to
##check that you have correctly chosen your rasters
rasters = arcpy.ListRasters("*", "GRID")
    print rasters

##If successful, run the following code. It will subtract the base temperature (283.15K or
##10*C) from all values and create a new raster appended with the letter m for Minus
outMinus = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg" + "\\" + raster + "m"
arcpy.env.overwriteOutput = True
for raster in rasters:
    outMinus = "C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg" + "\\" + raster + "m"
    minus = Minus(raster, 283.15)
    minus.save(outMinus)

##The subtraction (above) will generate negative values for pixels where the average
##temperature on that day was less than 283.15%/10*C so to remove all of these this code
##will set all negative pixel values to NoData. This process will not work with the GRID
##filetype, so it's time to convert to another file format. I chose TIFF.
##First, convert:
rasters = arcpy.ListRasters("*m", "GRID")
i = 0
inRast = rasters[i]
for raster in rasters:
    inRast = raster[i]
    arcpy.CopyRaster_management(inRast, inRast + ".tif")
    i = 1 + 1
##Second, set all negative values to NoData:
i = 0
rasters = arcpy.ListRasters("*tif", "*")
inRast = rasters[i]
for raster in rasters:
    inRast = rasters[i]
    outSetNull = SetNull(inRast, inRast, "VALUE < 0")
    outSetNull.save(inRast + "z")
    i = i + 1

##Sum all rasters to generate tiff of Growding Degree Days (GDD) according to the Winkler Index
rasters = arcpy.ListRasters("*z", "*")
GDD = CellStatistics([rasters], "SUM", "DATA")
GDD.save("C:\Users\strimble\Documents\Raster\Daily\DIntMea\DIntMea_Avg" + "\\" + "GDD")
